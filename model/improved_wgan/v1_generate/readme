# 1、本次改进 将wgan 改为 improved wgan
# 2、将优化器更改为adam
# 3、修改，每10 epcho就记录一次model
# 4、修改所有的初始化参数均改为：xavier_init he_init
# 5、相对于test20230120_19_59_21_coap_208_210_212_214_6.0w只是增加保存最好的一次model以及
# 6、将z_dim调成64

#############################################
本次改进：
1、增加attention padding mask
2、鉴别器，增加一层，第一层卷积看作一个embedding，将dim升到能够被num_head整除，之后先经过一个self-attenion layer

实验结果如下所示：鉴别器太弱
3333333333333333333333333332333333333333333333333333333333333333333333333333333333333333332333333333333333333333333333333333333233336333333333333333333333333333333333333333333333333333333333333333333333233333333333
3333333333333333333333333333333333333333333333332333333333333333333333633333332333333333333333333333333333333333233333333333333233333333323333333333333333333333333333333333333333333333323333333333333333333333333333
3333333333333323333333333332333333333333333333333333333236333333373333333333333333333333333333333333333333333333333333333333333323333333333333333333333333333333333333333333333333333233333333333333333333333333333333
3333333333333333333333333333333333333332333333333333333333333333333333333333333333333333323333233333333333333333333333333333333333333333333333333333333333333333333333333333333333332333333333333333333333333333333333
233333333333333323333333333332333333333333333333333333333333333333333333333333333333b333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333332333332333333333333333333333333333323333333333333333333333333323333333333333333333333323333333333333333333333333333333333333333333333333633333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333323333333333333333333333333
333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333332333333333333323333333333333333333333333333333333333333333333333333338333333333333333333333333333b335333333333
b33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233233333323333333333333333333333333333333333333333333333333333333323333333333333333333333333333333333f333333333333
3333333333333333333333333333333333333333333333333333333333333332333333337333333333333333333333333333333333322333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333
33333333333333333333333333333333333333333333333333333333333333333333333323333333333333333333333333333333b333333333333333333333333333333333333333333333333333323333333333333b333333333333333333353333333333333333333333
3333333333323333333333333333333333333333333333333333333333333333333333332333333233333333333333332332323333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333353333333333333
3333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333332333333333333333333333333333333333333333333333333333333333333333333333333333332333333333333333333333333333333b33333333333333332333333333333333333333333333333333333333333333
3332333333533333333333333333333333333333323333333333333333333333333333333333333333333333333333233333333333333333333333233333333333333333333333333333333333333333333333333333332333333333333333333333333333233333333333
3333333333333333333333333333333332333323333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333
3333333333333333333323333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333353335333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333323
3333333333333333333333333333333333333333333232333333333333333333333333333333333333333353333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333633333
3333333333333333333333333333333333333333333333333333333332333333333233333333333333333333333313333333333333333333333333333333333333333333333333333333323333333333333333333333333333333233333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333332323333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333323333333333333333333333333333333333333333333332333333333333333333333333333333233333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333363333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333335333333333333
3333333333333333333333333333333332333333333333333353333333333333333333333333333323333333333333332333333333333333233332333333333333333333333333333333333633333333333333333333333333333333333333333333323333333333333333
333333333333333333333333333333333333333333333333333b333333333333333333333333333333333323233333233233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333
3333333333333333333333333333333333333333333333333333333333233333333333332333333333333363333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333323633333333
3333333333333333333333333333333333333333333333333333333333633333332333333339333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333323333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333332333333333233333333333333333333333333333333333333333333333333b3333333333333333333333333333333333333333323333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333332333333333353333333333332333333333533333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333323333333333333
3333333333333333333333333333333333333332333333333333333335333333633333333333333333333333333333333333335333333333333333373333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333233333333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333323333333333333333333332333333335
3333333333333333333333333333333333333323333333333333333333333333333333333333333333332333333333333333333333333333333333323333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333233333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3323353333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333323333333333333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333332333333333333333333333336333333333333333333333333333333333333333333333333333323333333332333333333333333333333233333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333335333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333233333332333333323333333333333233333333333333333333333333333333333333333333333333333333333333323333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3233333333333333333333333233333333333333333333333333333333333333333333333333333333333323333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333335333333333333333333333233333
3333333333333333333333333333333333333333333333333332333333333333333333333333333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333353333333333333333333333333333333333333333333333335333333333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333323333333333333333333333333333333333333333333333333333
33333b3333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333332333333333333333333333333333332323333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333232333333333333333333333333333333333333323333333333333633333333333333333333333333333333333333333333323333333333333333533333333333333333333333
3333333333333333333333333333323333333333333333333333333333333333333332333333323333333333333333333333333333233333333333333333333333333333333333333333333333333333333333333332333233333333333333332333333333333333333333
3333333333333333333333333333333333333323233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333233333333333333333333332333333333332333333333333333333323333333333333333333333333333333333333333333333323333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333332333333333333333333333333333333333333333333b3333333333333333333333333333333333333333333333333333333323333333333333333333333333333333333333333333333333333333333333333333333332333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333323333333333333333333333333333333333333333353333333333333333233333333333333333333333
3333336333333323333333333333333333333333333333333333333333333333633333333333333333333333332333333333333333333333333333333333333333333333333333333333333333333333333333333333333133333333333333332333333333333333333333
3333333333333333333333333333333333333333333333233323333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333335333333333333333333333333333333333333333
3333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333332333333333333333333333333333333333333323333333333333332333333333333333333333333333332
3333333333333333333333333333333333333333333333333333333333333333333333333333333353333323333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333333
3333333333333333323333333333333333333333333333333233333333333333333333333333333333333333333333233333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333323333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333332333333333333323333333333333333333333333333333323333333333333333333533333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333335333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333353333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333233333333333333333333333333333333333323333333333333333333333333333333333333332333333333333333333333333333333332333233333333333333333333333333333333333323333333333333333333333333333333333333333333333333
3233373333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333332333333333333333333333333333333333333233333333333333333333233333333333333333333333333333333323333333333333333333333333333333323333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333332332333332333333333333333333333333333333333333333333333333333233333333333333333333333333333333333333333333333323333333333333333333333333333333333333333333333333333333333333333333323333333333333333332
Epoch 22
iter 100
disc cost 847124.625, real prob 0.47269517183303833
gen cost 0.7273877859115601, gen prob 0.33511582016944885
w-distance 0.6151912808418274
time0:02:01.144763

###########################################################改进########################################
发现：发现之前的鉴别器的self attention共享了参数
加上scope参数，使得多个self attention不共享参数
因此重新尝试一下之前的做法。
效果仍然很失败，鉴别器的损失很大
3311313333113303003331131031331333333331113131313113331333311111133313333311111313131133333311333313331103131311331113313133330130313313333331333333313133333333333331331333133331331333311311131133331313110333133331
3133313111111131113311311131313333311133333111331101330313333131133303111333113111311100131133333330310311133313331133111131331133333333313133313030133031333113333331133133333303311111113333311331311331113333331333
1333133333113113333333113111333333331313311113301333113331313111313133333103311311131110301111131331331333111313131311131331100333331131313331313333333131313133333333113331333130301111333113131333111310331313333331
1333111013311101133300313331311311313131111133131331311313333131331111333113133113111313331111113113111313331311111333133313311131111031313133113333303333313313333313331311131131331313130113333131310333111311311333
3311133311331333333113313133113333313131333331330113310131013311330313111311131313133131103330333331003313001303313333313131333313331331133330313333333311333031133133131311310333313333113333133113313131111131303303
3333133113333333031301313033333303333113100313331111303311301311311313113331113133311131133133111131333333811313113313333131311113133333333333313131113133333333303131333333010333111313333133333331333103333333133031
1331110111111113313313333111333333313133131333331333133110311133111313311313311133311033333333313111331311313311311111311313331313311311133333113111333333133133333133331313133331333113333333130133333333313331133131
Epoch 46
iter 100
disc cost 702.3037719726562, real prob 0.5865705609321594
gen cost -0.7027040719985962, gen prob 0.6324248909950256
w-distance -0.2311311960220337
time0:02:04.286866

#######################################################################################################
1、将self attention放在第一个位置，num_head = 1,试一下。
# 实验结果也崩了
鉴别器的损失很高，

Epoch 19
iter 400
disc cost 7758.1640625, real prob 0.4029858410358429
gen cost 1.3012570142745972, gen prob 0.25593361258506775
w-distance 0.7806798815727234
time0:08:25.898084

########################################################################################################
1、鉴别器的前面几层不适合self attention layer,打算将鉴别器的self-attention全部去掉看看效果
效果仍然不好。

#######################################################################################################
1、本次还原回去，还是在最后一层加上self attention，然后更新为efficient attention + Roformer
效果不好，需找原因：

#######################################################################################################
1、本次去掉efficient attention 看看效果，鉴别器的学习率降低到1e-4

效果不错，但是没有比过没有加入RoPE之前
####################################################################################################
鉴别器的学习率调回去，看一下 0.0004，z_dim调回50

###########################################################################################
加入efficient attention ，也加入Roformer 其余不变

##########################################################################################
efficient attention也像传统的self attetnion一样加入dropout以及scale

##################################################
dropout 只加
####################################################
只加 scale
###########################################
LAMBDA 系数 由10 变6
#####################################
新架构
#############E#####
去掉relu 变selu
######################
采用前归一化方式，传说前归一化更加稳定。